Description: Use system libcrypto++ if available
 Rather than always use the included libcrypto++ zipped source, check
 for and use the system's libcrypto++.
Author: Jeff Licquia <licquia@debian.org>
Forwarded: no
Last-Update: 2013-06-01
---
This patch header follows DEP-3: http://dep.debian.net/deps/dep3/
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -75,6 +75,7 @@
 	include(CheckIncludeFileCXX)
 	include(CheckSymbolExists)
 	include(CheckCSourceCompiles)
+	include(FindPkgConfig)
 
 	check_include_file_cxx(istream HAVE_ISTREAM)
 	check_include_file_cxx(ostream HAVE_OSTREAM)
@@ -212,6 +213,8 @@
 		check_library_exists("Xi" XISelectEvents "" HAVE_Xi)
 		check_library_exists("Xrandr" XRRQueryExtension "" HAVE_Xrandr)
 
+		pkg_search_module(CRYPTOPP libcrypto++)
+
 		if (HAVE_ICE)
 
 			# Assume we have SM if we have ICE.
@@ -255,6 +258,10 @@
       list(APPEND libs Xi)
     endif()
 
+		if (HAVE_CRYPTOPP)
+			list(APPEND libs CRYPTOPP_LIBRARIES)
+		endif()
+
 	endif()
 
 	# For config.h, set some static values; it may be a good idea to make
--- a/tools/CMakeLists.txt
+++ b/tools/CMakeLists.txt
@@ -13,7 +13,7 @@
 # You should have received a copy of the GNU General Public License
 # along with this program.  If not, see <http://www.gnu.org/licenses/>.
 
-set(cryptopp_dir cryptopp562)
+set(cryptopp_dir cryptopp)
 
 # only compile the crypto++ files we need.
 set(cryptopp_src
@@ -72,16 +72,20 @@
 endif()
 
 if (UNIX)
-	add_definitions(-DCRYPTOPP_DISABLE_ASM)
-	set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -g -O2 -pipe")
+	if (NOT CRYPTOPP_FOUND)
+		add_definitions(-DCRYPTOPP_DISABLE_ASM)
+		set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -g -O2 -pipe")
 	
-	if (APPLE)
-		if (DARWIN_VERSION GREATER 10)
-			set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wno-tautological-compare")
+		if (APPLE)
+			if (DARWIN_VERSION GREATER 10)
+				set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wno-tautological-compare")
+			endif()
+		else()
+			set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -march=native")
 		endif()
-	else()
-		set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -march=native")
 	endif()
 endif()
 
-add_library(cryptopp STATIC ${cryptopp_src})
+if (NOT CRYPTOPP_FOUND)
+	add_library(cryptopp STATIC ${cryptopp_src})
+endif()
--- a/tools/build/toolchain.py
+++ b/tools/build/toolchain.py
@@ -70,7 +70,7 @@
 	macSdk = None
 	
 	# cryptoPP dir with version number
-	cryptoPPDir = 'cryptopp562'
+	cryptoPPDir = 'cryptopp'
 
 	win32_generators = {
 		1 : Generator('Visual Studio 10'),
--- a/src/lib/io/CCryptoMode.h
+++ b/src/lib/io/CCryptoMode.h
@@ -17,9 +17,9 @@
 
 #pragma once
 
-#include <cryptopp562/gcm.h>
-#include <cryptopp562/modes.h>
-#include <cryptopp562/aes.h>
+#include <cryptopp/gcm.h>
+#include <cryptopp/modes.h>
+#include <cryptopp/aes.h>
 #include "ECryptoMode.h"
 #include "CString.h"
 
--- a/src/lib/io/CCryptoStream.h
+++ b/src/lib/io/CCryptoStream.h
@@ -20,8 +20,8 @@
 #include "BasicTypes.h"
 #include "CStreamFilter.h"
 #include "CCryptoMode.h"
-#include <cryptopp562/osrng.h>
-#include <cryptopp562/sha.h>
+#include <cryptopp/osrng.h>
+#include <cryptopp/sha.h>
 
 class CCryptoOptions;
 
